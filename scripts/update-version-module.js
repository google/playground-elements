/**
 * @license
 * Copyright 2021 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */

import * as fs from 'fs/promises';
import {dirname, join} from 'path';
import {fileURLToPath} from 'url';

// This script is automatically run before pack/publish to ensure that the
// src/shared/version.ts module contains the current package version number. We
// use this version number at runtime to ensure that the default unpkg.com
// sandbox base URL matches the version number of the components.

(async function main() {
  const thisDir = dirname(fileURLToPath(import.meta.url));

  const packageJsonPath = join(thisDir, '..', 'package.json');
  const packageJsonStr = await fs.readFile(packageJsonPath, 'utf8');
  const packageJson = JSON.parse(packageJsonStr);
  const version = packageJson.version;

  const newVersionModuleCode = `/**
 * @license
 * Copyright 2021 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */

// DO NOT UPDATE MANUALLY.

// This file is automatically generated by scripts/update-version-module.js
// before publishing.
export const version = '${version}';
`;

  const versionModulePath = join(thisDir, '..', 'src', 'shared', 'version.ts');
  const oldVersionModuleCode = await fs.readFile(versionModulePath, 'utf8');
  if (oldVersionModuleCode !== newVersionModuleCode) {
    await fs.writeFile(versionModulePath, newVersionModuleCode, 'utf8');
    console.log('Updated src/shared/version.ts, please commit this change.');
    // Fail to help the publisher remember to commit.
    process.exit(1);
  }
})();
